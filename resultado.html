<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Resultado</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 id="title">Resultado</h1>
      <p class="muted" id="sub"></p>

      <div class="grid2">
        <div class="card inner">
          <div class="pill" id="triadPill">Sua Tríade</div>
          <p class="muted" id="triadResumo" style="margin-top:10px;"></p>
          <div id="triadBlocks"></div>
        </div>

        <div class="card inner">
          <b>Ranking (pontuação)</b>
          <div id="ranking"></div>

          <div class="row" style="margin-top:12px;">
            <button class="btn" id="waBtn">Enviar no WhatsApp</button>
            <button class="btn secondary" id="copyBtn">Copiar</button>
            <button class="btn secondary" id="newBtn">Novo participante</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <b>Mensagem pronta</b>
      <p class="muted">Copie e cole no WhatsApp ou onde quiser.</p>
      <textarea id="msgBox" readonly></textarea>
    </div>
  </div>

  <script src="script.js"></script>
  <script>
    (async function init() {
      const cad = APP.getCadastro();
      if (!cad.nome) { window.location.href = "index.html"; return; }

      const matrix = await APP.loadMatrix();
      const scores = APP.computeScoresFromMatrix(matrix);
      const top = APP.top3(scores);
      const tri = APP.buildTriadText(top);

      document.getElementById("title").textContent = `Resultado Eneagrama — ${cad.nome}`;
      document.getElementById("sub").textContent =
        `Empresa: ${cad.empresa || "—"} • Email: ${cad.email || "—"} • Telefone: ${cad.telefone || "—"}`;

      document.getElementById("triadPill").textContent = tri.headline;
      document.getElementById("triadResumo").textContent = tri.resumo;

      // blocos
      const blocks = document.getElementById("triadBlocks");
      blocks.innerHTML = "";
      tri.blocos.forEach(b => {
        const div = document.createElement("div");
        div.className = "sec";
        div.innerHTML = `
          <h3 style="margin:10px 0 6px;">${b.title}</h3>
          <div class="muted"><b>Pontos fortes</b></div>
          <ul>${b.fortes.map(x => `<li>${x}</li>`).join("")}</ul>
          <div class="muted" style="margin-top:8px;"><b>A melhorar</b></div>
          <ul>${b.melhorar.map(x => `<li>${x}</li>`).join("")}</ul>
        `;
        blocks.appendChild(div);
      });

      // ranking
      const rk = document.getElementById("ranking");
      rk.innerHTML = "";
      Object.entries(scores).sort((a,b)=>b[1]-a[1]).forEach(([k,v]) => {
        const p = document.createElement("div");
        p.className = "rankLine";
        p.innerHTML = `<span><b>Tipo ${k}</b></span><span>${v}</span>`;
        rk.appendChild(p);
      });

      const message = APP.buildWhatsAppMessage(cad, tri, scores);
      document.getElementById("msgBox").value = message;

      document.getElementById("waBtn").addEventListener("click", () => {
        window.open(APP.toWaLink(message), "_blank");
      });

      document.getElementById("copyBtn").addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(message);
          alert("Copiado!");
        } catch {
          alert("Não consegui copiar automaticamente. Selecione e copie manualmente.");
        }
      });

      document.getElementById("newBtn").addEventListener("click", () => {
        APP.clearAll();
        window.location.href = "index.html";
      });
    })();
  </script>
</body>
</html>
