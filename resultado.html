<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>
  // SEUS DADOS
  const SERVICE_ID = "service_676gehg";
  const TEMPLATE_ID = "template_jkxxqz5";
  const PUBLIC_KEY = "dMy7jYWSeALMDD7TI";

  const STORAGE_KEY = "atrius_eneagrama_lead_v1";

  emailjs.init(PUBLIC_KEY);

  function getLeadOrThrow() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) throw new Error("Lead não encontrado no localStorage.");
    const lead = JSON.parse(raw);

    // valida mínimo para não enviar vazio
    if (!lead.email || !lead.nome_completo) throw new Error("Lead incompleto (email/nome_completo).");
    return lead;
  }

  async function enviarEmailRelatorio({ triade, relatorioHtml, relatorioTexto }) {
    const lead = getLeadOrThrow();

    const templateParams = {
      // ✅ Campos do lead
      nome: lead.nome || "",
      sobrenome: lead.sobrenome || "",
      nome_completo: lead.nome_completo || "",
      telefone: lead.telefone || "",
      email: lead.email || "",

      // ✅ Destinatário (alguns templates usam isso)
      to_email: lead.email || "",
      to_name: lead.nome_completo || "",

      // ✅ Assunto (como você pediu antes)
      subject: `Resultado eneagrama - ${lead.nome_completo || "Participante"}`,

      // ✅ Dados do resultado
      triade: triade || "",

      // ✅ Conteúdo do relatório
      // (use 1 ou os 2, conforme seu template)
      relatorio_html: relatorioHtml || "",
      relatorio_texto: relatorioTexto || "",
    };

    console.log("DEBUG templateParams:", templateParams); // <-- veja no console se está preenchendo

    return emailjs.send(SERVICE_ID, TEMPLATE_ID, templateParams);
  }

  // EXEMPLO DE USO:
  // chamar isso quando você já tiver triade e relatório pronto
  async function exemploDisparo() {
    try {
      const triade = "3-1-6"; // exemplo
      const relatorioHtml = "<h2>Seu resultado</h2><p>Conteúdo...</p>";
      const relatorioTexto = "Seu resultado: ...";

      await enviarEmailRelatorio({ triade, relatorioHtml, relatorioTexto });
      alert("E-mail enviado com sucesso!");
    } catch (err) {
      console.error(err);
      alert("Erro ao enviar e-mail: " + (err?.message || err));
    }
  }

  // exemploDisparo();
</script>
