<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quem sou eu — Resultado</title>

  <style>
    :root{
      --bg:#f3f5f8;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;
      --shadow:0 12px 34px rgba(15,23,42,.10);
      --accent:#f07a00;

      /* Paleta por tipo */
      --t1:#9ca3af;   /* Cinza */
      --t2:#22c55e;   /* Verde */
      --t3:#d4af37;   /* Ouro */
      --t4:#7c3aed;   /* Roxo */
      --t5:#0f172a;   /* Azul escuro */
      --t6:#8b6b4a;   /* Terroso */
      --t7:#f97316;   /* Laranja */
      --t8:#111827;   /* Preto */
      --t9:#38bdf8;   /* Azul céu */
    }

    *{ box-sizing:border-box }
    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    .wrap{
      max-width:1150px;
      margin:0 auto;
      padding:18px 16px 40px;
    }

    .header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      margin-bottom:14px;
    }
    .title h1{
      margin:0;
      font-size:44px;
      letter-spacing:-.5px;
    }
    .title p{
      margin:6px 0 0;
      color:var(--muted);
      font-size:14px;
    }

    .gridTop{
      display:grid;
      grid-template-columns: 1.6fr 1fr;
      gap:16px;
      align-items:start;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:18px;
    }

    .card h2{
      margin:0 0 8px;
      font-size:18px;
    }

    .topArea{
      display:grid;
      grid-template-columns: 1fr 320px;
      gap:14px;
      align-items:stretch;
      margin-top:12px;
    }

    .topList{
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .topItem{
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      background:#fff;
      position:relative;
      overflow:hidden;
    }

    .topItem .left{
      display:flex;
      flex-direction:column;
      gap:4px;
      z-index:1;
    }

    .rankLine{
      font-weight:900;
      font-size:16px;
      color:#0b2a5b;
      display:flex;
      align-items:center;
      gap:10px;
    }

    .badge{
      width:10px;
      height:10px;
      border-radius:999px;
      display:inline-block;
      border:1px solid rgba(0,0,0,.18);
    }

    .typeName{
      font-weight:800;
      font-size:13px;
      color:#0f172a;
    }

    .desc{
      font-size:13px;
      color:#475569;
      line-height:1.35;
      max-width:520px;
    }

    .score{
      font-weight:900;
      font-size:22px;
      color:#0f172a;
      min-width:56px;
      text-align:right;
      z-index:1;
    }

    .pieCard{
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      padding:12px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap:10px;
    }
    .pieHint{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }

    .smallTitle{
      font-weight:900;
      margin:0 0 6px;
      color:#0f172a;
      font-size:16px;
    }

    .quick{
      font-size:13px;
      color:#334155;
      line-height:1.35;
    }

    .section{
      margin-top:16px;
    }

    .gridBottom{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:16px;
      margin-top:14px;
    }

    .listBox{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:16px;
    }
    .listBox h4{
      margin:0 0 10px;
      font-size:16px;
      font-weight:900;
      color:#0f172a;
    }
    ul{
      margin:0;
      padding-left:18px;
      color:#0f172a;
      font-size:14px;
      line-height:1.6;
    }
    li{ margin:4px 0; }

    .error{
      display:none;
      background:#fff7f7;
      border:1px solid rgba(220,38,38,.25);
      color:#b91c1c;
      border-radius:14px;
      padding:12px;
      margin-top:12px;
      font-size:13px;
      line-height:1.35;
    }

    /* WhatsApp */
    .shareWrap{
      display:flex;
      justify-content:center;
      margin-top:14px;
    }
    .btnWhats{
      background:#25D366;
      color:#fff;
      border:0;
      cursor:pointer;
      font-weight:900;
      border-radius:999px;
      padding:14px 18px;
      font-size:15px;
      display:flex;
      align-items:center;
      gap:10px;
      box-shadow:0 10px 22px rgba(37,211,102,.25);
      width:100%;
      justify-content:center;
    }
    .btnWhats svg{ width:18px; height:18px; fill:#fff; }

    @media (max-width: 980px){
      .title h1{ font-size:36px; }
      .gridTop{ grid-template-columns: 1fr; }
      .topArea{ grid-template-columns:1fr; }
    }
    @media (max-width: 520px){
      .title h1{ font-size:30px; }
      .topItem{ padding:12px; }
      .desc{ font-size:12.5px; }
      .gridBottom{ grid-template-columns:1fr; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div class="title">
        <h1>Quem sou eu</h1>
        <p>Abaixo está o seu resultado com base nas respostas do formulário.</p>
      </div>
    </div>

    <div class="gridTop">
      <!-- LEFT -->
      <div class="card">
        <h2>Sua tríade principal (Top 3)</h2>
        <div style="color:var(--muted); font-size:13px;">Os 3 tipos mais altos (ordem decrescente).</div>

        <div class="topArea">
          <div>
            <div id="topList" class="topList"></div>
            <div id="errBox" class="error"></div>
          </div>

          <div class="pieCard">
            <div class="pieHint">Proporção dos 3 tipos mais altos.</div>
            <div id="pieWrap" style="display:flex;justify-content:center;align-items:center;"></div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="smallTitle">Resumo rápido</div>
        <div class="quick" id="quickResumo">Carregando…</div>

        <div class="shareWrap">
          <button class="btnWhats" id="btnWhats" type="button">
            <svg viewBox="0 0 32 32" aria-hidden="true">
              <path d="M19.11 17.35c-.27-.14-1.6-.79-1.85-.88-.25-.09-.43-.14-.61.14-.18.27-.7.88-.86 1.06-.16.18-.32.2-.59.07-.27-.14-1.15-.42-2.19-1.35-.81-.72-1.36-1.61-1.52-1.88-.16-.27-.02-.42.12-.56.12-.12.27-.32.41-.48.14-.16.18-.27.27-.45.09-.18.05-.34-.02-.48-.07-.14-.61-1.47-.84-2.01-.22-.53-.45-.46-.61-.47h-.52c-.18 0-.48.07-.73.34-.25.27-.95.93-.95 2.27 0 1.34.98 2.64 1.11 2.82.14.18 1.93 2.95 4.69 4.13.66.29 1.17.46 1.57.59.66.21 1.26.18 1.74.11.53-.08 1.6-.65 1.82-1.27.23-.62.23-1.15.16-1.27-.07-.12-.25-.2-.52-.34zM16.02 3C9.4 3 4 8.23 4 14.66c0 2.25.67 4.44 1.93 6.32L5 29l8.25-2.6c1.78.95 3.79 1.45 5.83 1.45 6.62 0 12.02-5.23 12.02-11.66C31.1 8.23 25.7 3 19.08 3h-3.06zm0 22.02c-1.88 0-3.72-.52-5.31-1.51l-.38-.24-4.89 1.54 1.6-4.67-.26-.39a9.9 9.9 0 0 1-1.64-5.49c0-5.46 4.64-9.9 10.34-9.9h3.06c5.7 0 10.34 4.44 10.34 9.9 0 5.46-4.64 9.9-10.34 9.9h-3.52z"/>
            </svg>
            Enviar por WhatsApp
          </button>
        </div>
      </div>
    </div>

    <!-- Como funciona em card branco -->
    <div class="card section">
      <h3 style="margin:0 0 8px; font-size:20px;">Como você tende a funcionar</h3>
      <p id="comoFunciona" style="margin:0;color:#334155;font-size:14px;line-height:1.45;">Carregando…</p>
    </div>

    <div class="gridBottom">
      <div class="listBox">
        <h4>Pontos fortes</h4>
        <ul id="listaFortes"></ul>
      </div>

      <div class="listBox">
        <h4>Pontos de atenção</h4>
        <ul id="listaAtencao"></ul>
      </div>
    </div>
  </div>

<script>
  const RESPOSTAS_KEY = "respostas";
  const MATRIZ_URL = "/data/matriz.json";

  // ✅ Número fixo do WhatsApp (somente dígitos, com DDI)
  const WHATS_NUMBER = "5551995912176"; // +55 51 99591-2176

  function cssVar(v){ return getComputedStyle(document.documentElement).getPropertyValue(v).trim(); }

  const TYPE_COLORS = {
    1: cssVar("--t1"), 2: cssVar("--t2"), 3: cssVar("--t3"),
    4: cssVar("--t4"), 5: cssVar("--t5"), 6: cssVar("--t6"),
    7: cssVar("--t7"), 8: cssVar("--t8"), 9: cssVar("--t9")
  };

  const TIPOS = {
    1:{ nome:"Perfeccionista / Reformador", curta:"Gosta de fazer certo, com padrão e qualidade." },
    2:{ nome:"Prestativo / Cuidador", curta:"Gosta de ajudar, cuidar e manter as pessoas bem." },
    3:{ nome:"Realizador", curta:"Gosta de resultado, metas e reconhecimento." },
    4:{ nome:"Individualista", curta:"Gosta de ser único, profundo e verdadeiro." },
    5:{ nome:"Investigador", curta:"Gosta de entender, pensar e agir com estratégia." },
    6:{ nome:"Leal", curta:"Gosta de segurança, confiança e previsibilidade." },
    7:{ nome:"Entusiasta", curta:"Gosta de novidades, energia e possibilidades." },
    8:{ nome:"Desafiador", curta:"Gosta de força, autonomia e fala direto." },
    9:{ nome:"Pacificador", curta:"Gosta de paz, harmonia e evitar conflito." }
  };

  const INFLUENCIA = {
    1:"mais cobrança e vontade de fazer certo",
    2:"mais cuidado com pessoas e busca de aprovação",
    3:"mais foco em resultado e em ser reconhecido",
    4:"mais emoção, profundidade e sensibilidade",
    5:"mais análise, estratégia e reserva",
    6:"mais cautela, dúvida e busca de segurança",
    7:"mais energia, pressa e vontade de fazer algo novo",
    8:"mais firmeza, confronto e decisão rápida",
    9:"mais calma, paciência e evitar briga"
  };

  const TYPE_FORTES = {
    1:["Capricho e qualidade","Organização","Responsabilidade","Foco em melhorar","Cuidado com erros"],
    2:["Empatia","Ajuda o time","Boa convivência","Apoia pessoas","Cria conexão"],
    3:["Entrega e produtividade","Foco em metas","Agilidade","Lidera pelo exemplo","Faz acontecer"],
    4:["Criatividade","Autenticidade","Percebe sentimentos","Profundidade","Visão diferente"],
    5:["Análise e lógica","Aprende rápido","Estratégia","Foco","Autonomia"],
    6:["Confiabilidade","Planejamento","Atenção a riscos","Lealdade","Compromisso com o grupo"],
    7:["Energia","Otimismo","Ideias e soluções","Flexibilidade","Comunicação leve"],
    8:["Firmeza","Coragem","Protege limites","Decide rápido","Resistência à pressão"],
    9:["Calma","Mediação","Escuta","Equilíbrio","Boa convivência"]
  };

  const TYPE_ATENCAO = {
    1:["Rigidez","Crítica demais","Impaciência","Se cobrar muito","Dificuldade em delegar"],
    2:["Dificuldade de dizer não","Querer agradar sempre","Se frustrar quando não valorizam","Se doar demais","Guardar mágoa"],
    3:["Pressa e ansiedade","Se cobrar demais","Confundir valor com resultado","Querer controle","Dificuldade de parar"],
    4:["Oscilar no humor","Comparação","Se fechar","Levar para o lado pessoal","Perder foco prático"],
    5:["Pensar demais","Se fechar","Demorar para agir","Falar pouco e parecer frio","Evitar emoções"],
    6:["Ansiedade","Dúvida constante","Medo de errar","Desconfiança","Precisar de garantia pra tudo"],
    7:["Dispersar","Começar e não terminar","Evitar desconforto","Impulsividade","Falta de rotina"],
    8:["Tom duro","Controlar demais","Explodir fácil","Não mostrar fraqueza","Confrontar sem necessidade"],
    9:["Procrastinar","Evitar conflito","Engolir frustração","Dificuldade de decidir","Falta de prioridade"]
  };

  function uniq(arr){
    const out=[]; const seen=new Set();
    for(const x of arr){
      const k=(x||"").toLowerCase().trim();
      if(!k || seen.has(k)) continue;
      seen.add(k); out.push(x);
    }
    return out;
  }
  function limit(arr, n){ return arr.slice(0,n); }

  function key84(a,b,c){
    const s=[a,b,c].sort((x,y)=>x-y);
    return `${s[0]}-${s[1]}-${s[2]}`;
  }

  function buildTriadeMap84(){
    const map = {};
    for(let a=1;a<=9;a++){
      for(let b=a+1;b<=9;b++){
        for(let c=b+1;c<=9;c++){
          const k = `${a}-${b}-${c}`;
          const fortes = limit(uniq([...(TYPE_FORTES[a]||[]), ...(TYPE_FORTES[b]||[]), ...(TYPE_FORTES[c]||[])]), 7);
          const atencao = limit(uniq([...(TYPE_ATENCAO[a]||[]), ...(TYPE_ATENCAO[b]||[]), ...(TYPE_ATENCAO[c]||[])]), 7);
          map[k] = { fortes, atencao };
        }
      }
    }
    return map;
  }

  const TRIADE_MAP = buildTriadeMap84();

  function getLocalJSON(key){
    try{ return JSON.parse(localStorage.getItem(key) || "null"); }
    catch{ return null; }
  }

  // ✅ tenta achar nome/email/telefone em várias chaves
  function readUserData(){
    const candidates = [
      getLocalJSON("userData"),
      getLocalJSON("dados_iniciais"),
      getLocalJSON("dadosUsuario")
    ].filter(Boolean);

    const raw = candidates[0] || {};

    const nome = raw.nome || raw.name || raw.nomeCompleto || "(não informado)";
    const email = raw.email || raw.mail || "(não informado)";
    const telefone = raw.telefone || raw.phone || raw.fone || "(não informado)";

    return { nome, email, telefone };
  }

  function showError(msg){
    const el = document.getElementById("errBox");
    el.style.display = "block";
    el.textContent = msg;
  }

  async function loadMatriz(){
    const res = await fetch(MATRIZ_URL, { cache: "no-store" });
    if(!res.ok) throw new Error("Não consegui carregar /data/matriz.json. Verifique se o arquivo existe na pasta /data.");
    return res.json();
  }

  function computeScore(respostas, matriz){
    const score = {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0};
    respostas.forEach(r=>{
      const key = `${r.pergunta}_${r.alternativa}`;
      const w = matriz[key];
      if(!w) return;
      for(const t in w) score[t] += w[t];
    });
    return score;
  }

  function top3FromScore(score){
    return Object.entries(score)
      .map(([t,v])=>({ t:Number(t), v:Number(v) }))
      .sort((a,b)=>b.v-a.v)
      .slice(0,3);
  }

  function renderTop3(top3){
    const list = document.getElementById("topList");
    list.innerHTML = top3.map((it, idx)=>{
      const tipo = TIPOS[it.t];
      const rank = (idx+1) + "º — Tipo " + it.t;
      const color = TYPE_COLORS[it.t] || "#111827";
      return `
        <div class="topItem">
          <div class="left">
            <div class="rankLine">
              <span class="badge" style="background:${color}"></span>
              ${rank}
            </div>
            <div class="typeName">${tipo?.nome || ""}</div>
            <div class="desc">${tipo?.curta || ""}</div>
          </div>
          <div class="score">${it.v}</div>
        </div>
      `;
    }).join("");
  }

  // PIE (SVG)
  function polarToCartesian(cx, cy, r, angleDeg){
    const rad = (angleDeg - 90) * Math.PI / 180.0;
    return { x: cx + (r * Math.cos(rad)), y: cy + (r * Math.sin(rad)) };
  }
  function arcPath(cx, cy, r, startAngle, endAngle){
    const start = polarToCartesian(cx, cy, r, endAngle);
    const end = polarToCartesian(cx, cy, r, startAngle);
    const largeArcFlag = (endAngle - startAngle) <= 180 ? "0" : "1";
    return `M ${cx} ${cy} L ${start.x} ${start.y} A ${r} ${r} 0 ${largeArcFlag} 0 ${end.x} ${end.y} Z`;
  }
  function renderPie(top3){
    const total = top3.reduce((s,x)=>s+x.v,0) || 1;
    let start = 0;
    const cx = 110, cy = 110, r = 92;

    const slices = top3.map((it)=>{
      const frac = it.v / total;
      const angle = frac * 360;
      const end = start + angle;
      const path = arcPath(cx, cy, r, start, end);
      start = end;
      return { t: it.t, v: it.v, path };
    });

    const svg = `
      <svg width="220" height="220" viewBox="0 0 220 220" aria-label="Gráfico de pizza">
        ${slices.map(s=>{
          const color = TYPE_COLORS[s.t] || "#111827";
          return `<path d="${s.path}" fill="${color}" stroke="white" stroke-width="3"></path>`;
        }).join("")}
        <circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="rgba(15,23,42,.10)" stroke-width="1"/>
      </svg>
    `;
    document.getElementById("pieWrap").innerHTML = svg;
  }

  function renderTextos(top3){
    const t1 = top3[0].t, t2 = top3[1].t, t3 = top3[2].t;
    const k = key84(t1,t2,t3);
    const base = TRIADE_MAP[k] || null;

    const resumoRapido =
      `Seu tipo mais forte é o Tipo ${t1}, com influência dos Tipos ${t2} e ${t3}.`;

    document.getElementById("quickResumo").textContent = resumoRapido;

    const n1 = TIPOS[t1]?.nome || `Tipo ${t1}`;
    const n2 = TIPOS[t2]?.nome || `Tipo ${t2}`;
    const n3 = TIPOS[t3]?.nome || `Tipo ${t3}`;

    const funcionamento =
      `Sua tríade principal é <b>${t1}-${t2}-${t3}</b>. ` +
      `O seu tipo dominante é o <b>Tipo ${t1}</b> (${n1}). ` +
      `Na prática, isso aparece como: <b>${TIPOS[t1]?.curta || ""}</b> ` +
      `<br><br>` +
      `A influência do <b>Tipo ${t2}</b> (${n2}) traz <b>${INFLUENCIA[t2]}</b>. ` +
      `A influência do <b>Tipo ${t3}</b> (${n3}) traz <b>${INFLUENCIA[t3]}</b>.`;

    document.getElementById("comoFunciona").innerHTML = funcionamento;

    const fortes = (base?.fortes && base.fortes.length)
      ? base.fortes
      : limit(uniq([...(TYPE_FORTES[t1]||[]), ...(TYPE_FORTES[t2]||[]), ...(TYPE_FORTES[t3]||[])]), 7);

    const atencao = (base?.atencao && base.atencao.length)
      ? base.atencao
      : limit(uniq([...(TYPE_ATENCAO[t1]||[]), ...(TYPE_ATENCAO[t2]||[]), ...(TYPE_ATENCAO[t3]||[])]), 7);

    document.getElementById("listaFortes").innerHTML = fortes.map(x=>`<li>${x}</li>`).join("");
    document.getElementById("listaAtencao").innerHTML = atencao.map(x=>`<li>${x}</li>`).join("");

    // ✅ monta mensagem do WhatsApp com dados do usuário + resumo
    const user = readUserData();
    const msg =
`*Resultado do Teste Eneagrama (Atrius)*
Nome: ${user.nome}
Email: ${user.email}
Telefone: ${user.telefone}

${resumoRapido}

Tríade: ${t1}-${t2}-${t3}
Dominante: Tipo ${t1} (${TIPOS[t1]?.nome || ""})

Pontuações (Top 3):
1º Tipo ${t1}: ${top3[0].v}
2º Tipo ${t2}: ${top3[1].v}
3º Tipo ${t3}: ${top3[2].v}`;

    const waUrl = `https://wa.me/${WHATS_NUMBER}?text=${encodeURIComponent(msg)}`;
    document.getElementById("btnWhats").onclick = ()=> window.open(waUrl, "_blank", "noopener,noreferrer");
  }

  (async function init(){
    try{
      const respostas = getLocalJSON(RESPOSTAS_KEY) || [];
      if(!Array.isArray(respostas) || respostas.length === 0){
        showError("Não encontrei respostas salvas. Volte e finalize o teste novamente.");
        document.getElementById("quickResumo").textContent = "Sem dados.";
        document.getElementById("comoFunciona").textContent = "Sem dados.";
        return;
      }

      const matriz = await loadMatriz();
      const score = computeScore(respostas, matriz);
      const top3 = top3FromScore(score);

      renderTop3(top3);
      renderPie(top3);
      renderTextos(top3);

    }catch(err){
      console.error(err);
      showError(err?.message || String(err));
      document.getElementById("quickResumo").textContent = "Erro ao carregar.";
      document.getElementById("comoFunciona").textContent = "Erro ao carregar.";
    }
  })();
</script>
</body>
</html>
