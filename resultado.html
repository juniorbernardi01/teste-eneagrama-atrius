<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quem sou eu — Resultado</title>
  <style>
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#f3f5f8;color:#0f172a}
    .wrap{max-width:980px;margin:0 auto;padding:18px 16px 40px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px}
    .muted{color:#64748b;font-size:13px}
    .notice{display:none;margin:10px 0 14px;border-radius:12px;padding:12px 14px;border:1px solid rgba(34,197,94,.35);background:#f0fdf4;font-weight:800}
    .notice.err{border-color:rgba(220,38,38,.25);background:#fff7f7;color:#b91c1c}
    pre{white-space:pre-wrap;word-break:break-word;background:#0b1220;color:#e5e7eb;border-radius:12px;padding:14px;margin:12px 0 0;font-size:13px;line-height:1.45}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1 style="margin:0 0 6px;font-size:28px;">Quem sou eu — Resultado</h1>
      <div class="muted">O site mostra o resultado abaixo e também envia um e-mail simples.</div>

      <div id="noticeOk" class="notice">✅ E-mail enviado com sucesso!</div>
      <div id="noticeErr" class="notice err">⚠️ Não consegui enviar o e-mail (veja console).</div>

      <pre id="previewText">Carregando…</pre>
    </div>
  </div>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

<script>
  // ===========================
  // EmailJS (suas credenciais)
  // ===========================
  const EMAILJS_SERVICE_ID = "service_676gehg";
  const EMAILJS_TEMPLATE_ID = "template_jkxxqz5";
  const EMAILJS_PUBLIC_KEY  = "dMy7jYWSeALMDD7TI";

  // trava por sessão (evita duplicar)
  const EMAIL_SENT_LOCK = "atrius_eneagrama_email_sent_this_session";

  // destino fixo (se quiser mandar sempre pro Junior)
  const REPORT_TO_EMAIL = "juniorbernardi@atrius.ind.br";

  // ===== Keys do projeto =====
  const RESPOSTAS_KEY = "respostas";
  const LEAD_KEY_MAIN = "atrius_eneagrama_lead_v1";
  const LEAD_KEY_FALLBACK_1 = "lead";
  const LEAD_KEY_FALLBACK_2 = "atrius_lead";
  const LEAD_KEY_FALLBACK_3 = "lead_inicial";

  // ✅ caminho relativo
  const MATRIZ_URL = "data/matriz.json";

  function getLocalJSON(key){
    try{ return JSON.parse(localStorage.getItem(key) || "null"); }
    catch{ return null; }
  }

  function getLead(){
    const keys = [LEAD_KEY_MAIN, LEAD_KEY_FALLBACK_1, LEAD_KEY_FALLBACK_2, LEAD_KEY_FALLBACK_3];
    for(const k of keys){
      const obj = getLocalJSON(k);
      if(obj && (obj.email || obj.nome || obj.nome_completo)) return obj;
    }
    return null;
  }

  async function loadMatriz(){
    const res = await fetch(MATRIZ_URL, { cache: "no-store" });
    if(!res.ok) throw new Error("Não consegui carregar data/matriz.json. Verifique se o arquivo existe na pasta /data.");
    return res.json();
  }

  function computeScore(respostas, matriz){
    const score = {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0};
    respostas.forEach(r=>{
      const key = `${r.pergunta}_${r.alternativa}`;
      const w = matriz[key];
      if(!w) return;
      for(const t in w) score[t] += w[t];
    });
    return score;
  }

  function top3FromScore(score){
    return Object.entries(score)
      .map(([t,v])=>({ t:Number(t), v:Number(v) }))
      .sort((a,b)=>b.v-a.v)
      .slice(0,3);
  }

  // % normalizado pelo maior tipo (maior = 100%)
  function normalizeToPercent(score){
    const vals = Object.values(score).map(v=>Number(v)||0);
    const max = Math.max(...vals, 0) || 1;
    const pct = {};
    for(let t=1;t<=9;t++){
      pct[t] = Math.round((Number(score[t]||0) / max) * 100);
    }
    return pct;
  }

  function buildTextReport(user, score, top3){
    const nome = (user?.nome_completo || (user?.nome && user?.sobrenome ? (user.nome + " " + user.sobrenome) : user?.nome) || "—").trim();
    const email = (user?.email || "—").trim();
    const tel = (user?.telefone || user?.telefone_digits || "—").toString().trim();

    const triade = `${top3[0].t}-${top3[1].t}-${top3[2].t}`;
    const pct = normalizeToPercent(score);

    const lines = [];
    lines.push("RESULTADO ENEAGRAMA (TRIADE)");
    lines.push("----------------------------------------");
    lines.push(`Nome completo: ${nome}`);
    lines.push(`Telefone: ${tel}`);
    lines.push(`Email: ${email}`);
    lines.push("");
    lines.push(`Tríade principal (Top 3): ${triade}`);
    lines.push(`1) Tipo ${top3[0].t} = ${top3[0].v} pts`);
    lines.push(`2) Tipo ${top3[1].t} = ${top3[1].v} pts`);
    lines.push(`3) Tipo ${top3[2].t} = ${top3[2].v} pts`);
    lines.push("");
    lines.push("Percentual por tipo (normalizado):");
    for(let t=1;t<=9;t++){
      lines.push(`Tipo ${t}: ${pct[t]}%`);
    }
    lines.push("----------------------------------------");
    lines.push("Atrius • Resultado gerado automaticamente");

    return lines.join("\n");
  }

  async function sendEmailTextOnce(user, texto){
    if(sessionStorage.getItem(EMAIL_SENT_LOCK) === "1") return;
    sessionStorage.setItem(EMAIL_SENT_LOCK, "1");

    const nome = (user?.nome_completo || user?.nome || "Participante").trim();
    const assunto = `Resultado eneagrama - ${nome}`;

    emailjs.init({ publicKey: EMAILJS_PUBLIC_KEY });

    // ✅ template precisa ter {{texto}} no Content
    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
      assunto,
      texto,
      name: nome,
      email: (user?.email || ""),
      to_email: REPORT_TO_EMAIL
    });
  }

  (async function init(){
    try{
      const respostas = getLocalJSON(RESPOSTAS_KEY) || [];
      const user = getLead();

      if(!Array.isArray(respostas) || respostas.length === 0){
        document.getElementById("previewText").textContent =
          "Não encontrei respostas salvas. Volte e finalize o teste novamente.";
        return;
      }

      const matriz = await loadMatriz();
      const score = computeScore(respostas, matriz);
      const top3 = top3FromScore(score);

      const texto = buildTextReport(user, score, top3);

      // preview na tela (pra você ver exatamente o que vai no e-mail)
      document.getElementById("previewText").textContent = texto;

      // envia e-mail (1x por sessão)
      if(user && (user.email || user.nome || user.nome_completo)){
        await sendEmailTextOnce(user, texto);
        document.getElementById("noticeOk").style.display = "block";
      } else {
        // sem lead -> não envia
        document.getElementById("noticeErr").style.display = "block";
        document.getElementById("noticeErr").textContent =
          "⚠️ Lead não encontrado (nome/email/telefone). Não enviei e-mail.";
      }

    }catch(err){
      console.error("Erro:", err);
      document.getElementById("noticeErr").style.display = "block";
      document.getElementById("previewText").textContent =
        "Erro ao gerar/enviar. Veja o console.";
    }
  })();
</script>
</body>
</html>
