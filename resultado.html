<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quem sou eu ‚Äî Resultado</title>

  <style>
    :root{
      --bg:#f3f5f8;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;
      --shadow:0 12px 34px rgba(15,23,42,.10);
      --accent:#f07a00;

      --t1:#9ca3af;
      --t2:#22c55e;
      --t3:#d4af37;
      --t4:#7c3aed;
      --t5:#0877ff;
      --t6:#8b6b4a;
      --t7:#f97316;
      --t8:#111827;
      --t9:#38bdf8;

      --soft:#fff6ee;
      --softBorder:rgba(240,122,0,.35);
      --wa:#25D366;
      --waHover:#1fb857;

      --okBg:#ecfdf5;
      --okBorder:rgba(16,185,129,.35);
      --okText:#065f46;

      --warnBg:#fff7ed;
      --warnBorder:rgba(240,122,0,.35);
      --warnText:#7c2d12;

      --errBg:#fff7f7;
      --errBorder:rgba(220,38,38,.25);
      --errText:#b91c1c;
    }

    *{ box-sizing:border-box }
    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    .wrap{
      max-width:1150px;
      margin:0 auto;
      padding:18px 16px 40px;
    }

    .header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      margin-bottom:14px;
    }
    .title h1{
      margin:0;
      font-size:44px;
      letter-spacing:-.5px;
    }
    .title p{
      margin:6px 0 0;
      color:var(--muted);
      font-size:14px;
    }

    .statusBar{
      display:none;
      margin:14px 0 14px;
      border-radius:14px;
      padding:12px 14px;
      border:1px solid var(--warnBorder);
      background:var(--warnBg);
      color:var(--warnText);
      font-weight:800;
      line-height:1.35;
      box-shadow:var(--shadow);
    }
    .statusBar.ok{
      border-color:var(--okBorder);
      background:var(--okBg);
      color:var(--okText);
    }
    .statusBar.err{
      border-color:var(--errBorder);
      background:var(--errBg);
      color:var(--errText);
    }
    .statusSmall{
      display:block;
      font-weight:700;
      opacity:.9;
      margin-top:4px;
      font-size:12px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:18px;
    }

    .card h2{
      margin:0 0 8px;
      font-size:18px;
    }

    .topArea{
      display:grid;
      grid-template-columns: 1fr 320px;
      gap:14px;
      align-items:stretch;
      margin-top:12px;
    }

    .topList{
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .topItem{
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      background:#fff;
      position:relative;
      overflow:hidden;
    }

    .topItem .left{
      display:flex;
      flex-direction:column;
      gap:4px;
      z-index:1;
    }

    .rankLine{
      font-weight:900;
      font-size:16px;
      color:#0b2a5b;
      display:flex;
      align-items:center;
      gap:10px;
    }

    .badge{
      width:10px;
      height:10px;
      border-radius:999px;
      display:inline-block;
      border:1px solid rgba(0,0,0,.18);
    }

    .typeName{
      font-weight:800;
      font-size:13px;
      color:#0f172a;
    }

    .desc{
      font-size:13px;
      color:#475569;
      line-height:1.35;
      max-width:520px;
    }

    .score{
      font-weight:900;
      font-size:22px;
      color:#0f172a;
      min-width:56px;
      text-align:right;
      z-index:1;
    }

    .pieCard{
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      padding:12px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      gap:10px;
      min-height: 220px;
    }

    .summaryCard{
      margin-top:14px;
      background:var(--soft);
      border:1px solid var(--softBorder);
      border-radius:18px;
      padding:16px;
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .summaryRow{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:flex-start;
      justify-content:space-between;
    }

    .miniInfo{
      flex:1;
      min-width:240px;
      background:#fff;
      border:1px solid rgba(15,23,42,.10);
      border-radius:14px;
      padding:12px;
    }
    .miniInfo .k{
      font-size:12px;
      color:var(--muted);
      margin-bottom:4px;
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:.3px;
    }
    .miniInfo .v{
      font-size:14px;
      color:#0f172a;
      font-weight:800;
      line-height:1.35;
      word-break:break-word;
    }

    .quickBox{
      flex:1.2;
      min-width:260px;
      background:#fff;
      border:1px solid rgba(15,23,42,.10);
      border-radius:14px;
      padding:12px;
    }
    .quickTitle{
      font-weight:900;
      margin:0 0 6px;
      color:#0f172a;
      font-size:14px;
    }
    .quick{
      font-size:13px;
      color:#334155;
      line-height:1.35;
    }

    .btnRow{ display:flex; justify-content:flex-end; }

    .btnWA{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:12px 14px;
      border-radius:14px;
      font-weight:900;
      border:0;
      cursor:pointer;
      font-size:14px;
      background:var(--wa);
      color:#fff;
      min-width:240px;
    }
    .btnWA:hover{ background:var(--waHover); }

    .section{ margin-top:16px; }
    .section h3{
      margin:0 0 10px;
      font-size:20px;
      letter-spacing:-.2px;
    }
    .funcCard{
      background:#fff;
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:16px;
    }
    .funcText{
      margin:0;
      color:#334155;
      font-size:14px;
      line-height:1.55;
    }

    .gridBottom{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:16px;
      margin-top:14px;
    }

    .listBox{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:16px;
    }
    .listBox h4{
      margin:0 0 10px;
      font-size:16px;
      font-weight:900;
      color:#0f172a;
    }
    ul{
      margin:0;
      padding-left:18px;
      color:#0f172a;
      font-size:14px;
      line-height:1.6;
    }
    li{ margin:4px 0; }

    .error{
      display:none;
      background:#fff7f7;
      border:1px solid rgba(220,38,38,.25);
      color:#b91c1c;
      border-radius:14px;
      padding:12px;
      margin-top:12px;
      font-size:13px;
      line-height:1.35;
    }

    .debugBox{
      display:none;
      margin-top:14px;
      background:#0b1220;
      color:#dbeafe;
      border:1px solid rgba(148,163,184,.25);
      border-radius:14px;
      padding:12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      white-space:pre-wrap;
      word-break:break-word;
      box-shadow:var(--shadow);
    }

    @media (max-width: 980px){
      .title h1{ font-size:36px; }
      .topArea{ grid-template-columns:1fr; }
      .btnRow{ justify-content:stretch; }
      .btnWA{ width:100%; }
    }
    @media (max-width: 520px){
      .title h1{ font-size:30px; }
      .topItem{ padding:12px; }
      .desc{ font-size:12.5px; }
      .gridBottom{ grid-template-columns:1fr; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div class="title">
        <h1>Quem sou eu</h1>
        <p>Abaixo est√° o seu resultado com base nas respostas do formul√°rio.</p>
      </div>
    </div>

    <!-- ‚úÖ AVISO (email status) -->
    <div id="emailStatus" class="statusBar">Carregando‚Ä¶</div>

    <div class="card">
      <h2>Sua tr√≠ade principal (Top 3)</h2>
      <div style="color:var(--muted); font-size:13px;">Os 3 tipos mais altos (ordem decrescente).</div>

      <div class="topArea">
        <div>
          <div id="topList" class="topList"></div>
          <div id="errBox" class="error"></div>
        </div>

        <div class="pieCard">
          <div id="pieWrap" style="display:flex;justify-content:center;align-items:center;"></div>
        </div>
      </div>

      <div class="summaryCard">
        <div class="summaryRow">
          <div class="miniInfo">
            <div class="k">Dados</div>
            <div class="v" id="dadosUser">Carregando‚Ä¶</div>
          </div>

          <div class="quickBox">
            <div class="quickTitle">Resumo do resultado</div>
            <div class="quick" id="quickResumo">Carregando‚Ä¶</div>
          </div>
        </div>

        <div class="btnRow">
          <button class="btnWA" id="btnWhats">Enviar no WhatsApp</button>
        </div>
      </div>
    </div>

    <div class="section">
      <h3>Como voc√™ tende a funcionar</h3>
      <div class="funcCard">
        <p class="funcText" id="comoFunciona">Carregando‚Ä¶</p>
      </div>
    </div>

    <div class="gridBottom">
      <div class="listBox">
        <h4>Pontos fortes</h4>
        <ul id="listaFortes"></ul>
      </div>

      <div class="listBox">
        <h4>Pontos de aten√ß√£o</h4>
        <ul id="listaAtencao"></ul>
      </div>
    </div>

    <!-- Debug opcional: abre com ?debug=1 -->
    <div id="debugBox" class="debugBox"></div>
  </div>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

<script>
  // ===========================
  // EmailJS (suas credenciais)
  // ===========================
  const EMAILJS_SERVICE_ID = "service_676gehg";
  const EMAILJS_TEMPLATE_ID = "template_jkxxqz5";
  const EMAILJS_PUBLIC_KEY  = "dMy7jYWSeALMDD7TI";
  const EMAIL_SENT_LOCK = "atrius_eneagrama_email_sent_this_session";

  // ===== Keys do projeto =====
  const RESPOSTAS_KEY = "respostas";
  const LEAD_KEY_MAIN = "atrius_eneagrama_lead_v1";
  const LEAD_KEY_FALLBACK_1 = "lead";
  const LEAD_KEY_FALLBACK_2 = "atrius_lead";
  const LEAD_KEY_FALLBACK_3 = "lead_inicial";

  // ‚úÖ caminho relativo
  const MATRIZ_URL = "data/matriz.json";

  // WhatsApp destino: 55 51 9591-2176
  const WHATS_NUMBER = "555195912176";

  // ================= Debug helpers =================
  const DEBUG = new URLSearchParams(location.search).get("debug") === "1";
  const debugBox = document.getElementById("debugBox");

  function dlog(...args){
    // Mesmo que o console esteja ‚Äúfiltrado‚Äù, isso ajuda quando voc√™ habilitar.
    try{ console.log("[ENEAGRAMA]", ...args); }catch{}
    if(DEBUG){
      debugBox.style.display = "block";
      const txt = args.map(a=>{
        try{ return typeof a === "string" ? a : JSON.stringify(a, null, 2); }
        catch{ return String(a); }
      }).join(" ");
      debugBox.textContent += txt + "\n";
    }
  }

  function setEmailStatus(type, title, subtitle){
    const el = document.getElementById("emailStatus");
    el.style.display = "block";
    el.classList.remove("ok","err");

    if(type === "ok") el.classList.add("ok");
    if(type === "err") el.classList.add("err");

    el.innerHTML = `
      ${title}
      ${subtitle ? `<span class="statusSmall">${subtitle}</span>` : ""}
    `;
  }

  function cssVar(v){ return getComputedStyle(document.documentElement).getPropertyValue(v).trim(); }

  const TYPE_COLORS = {
    1: cssVar("--t1"), 2: cssVar("--t2"), 3: cssVar("--t3"),
    4: cssVar("--t4"), 5: cssVar("--t5"), 6: cssVar("--t6"),
    7: cssVar("--t7"), 8: cssVar("--t8"), 9: cssVar("--t9")
  };

  const TIPOS = {
    1:{ nome:"Perfeccionista / Reformador", curta:"Gosta de fazer certo, com padr√£o e qualidade." },
    2:{ nome:"Prestativo / Cuidador", curta:"Gosta de ajudar, cuidar e manter as pessoas bem." },
    3:{ nome:"Realizador", curta:"Gosta de resultado, metas e reconhecimento." },
    4:{ nome:"Individualista", curta:"Gosta de ser √∫nico, profundo e verdadeiro." },
    5:{ nome:"Investigador", curta:"Gosta de entender, pensar e agir com estrat√©gia." },
    6:{ nome:"Leal", curta:"Gosta de seguran√ßa, confian√ßa e previsibilidade." },
    7:{ nome:"Entusiasta", curta:"Gosta de novidades, energia e possibilidades." },
    8:{ nome:"Desafiador", curta:"Gosta de for√ßa, autonomia e fala direto." },
    9:{ nome:"Pacificador", curta:"Gosta de paz, harmonia e evitar conflito." }
  };

  const INFLUENCIA = {
    1:"mais cobran√ßa e vontade de fazer certo",
    2:"mais cuidado com pessoas e vontade de ajudar",
    3:"mais foco em resultado e em ser reconhecido",
    4:"mais emo√ß√£o, sensibilidade e profundidade",
    5:"mais an√°lise, estrat√©gia e reserva",
    6:"mais cautela e busca de seguran√ßa",
    7:"mais energia e vontade de fazer algo novo",
    8:"mais firmeza e decis√£o r√°pida",
    9:"mais calma e evitar briga"
  };

  const TYPE_FORTES = {
    1:["Cuida da qualidade e do capricho","Organiza e coloca ordem no que est√° bagun√ßado","√â respons√°vel e confi√°vel","Percebe erros e evita retrabalho","Gosta de melhorar as coisas aos poucos","Cumpre regras e combina√ß√µes","Mant√©m padr√£o mesmo com press√£o"],
    2:["Ajuda as pessoas de verdade","Percebe quando algu√©m n√£o est√° bem","Cria um clima bom no time","√â prestativo(a) e acolhedor(a)","Tem facilidade para cooperar","Faz o outro se sentir importante","Resolve coisas com gentileza"],
    3:["Entrega resultado e faz acontecer","Foca em metas e n√£o se perde","Tem energia e ritmo de trabalho","Se adapta para dar certo","Motiva o time pelo exemplo","Aprende r√°pido o que precisa para vencer","Gosta de crescer e evoluir"],
    4:["Tem criatividade e ideias diferentes","Percebe sentimentos com facilidade","Busca ser verdadeiro(a) e aut√™ntico(a)","Tem profundidade e vis√£o humana","Gosta de fazer com personalidade","Enxerga detalhes que outros n√£o veem","Valoriza sentido e prop√≥sito"],
    5:["Pensa com l√≥gica e clareza","Aprende r√°pido e gosta de entender","Analisa antes de agir","√â estrat√©gico(a) e cuidadoso(a)","Faz perguntas inteligentes","Se concentra bem quando precisa","Trabalha bem sozinho(a)"],
    6:["√â leal e comprometido(a)","V√™ riscos antes de acontecer","Planeja e evita surpresas","Cumpre o que promete","Protege o time e a empresa","Tem senso de responsabilidade","Gosta de trabalhar com seguran√ßa"],
    7:["Traz energia e bom humor","V√™ possibilidades e solu√ß√µes","√â criativo(a) para resolver problemas","Se adapta f√°cil a mudan√ßas","Gosta de aprender coisas novas","Tem iniciativa e movimento","Anima o ambiente"],
    8:["√â firme e decidido(a)","Protege o que √© importante","N√£o foge de problema","Tem coragem para falar o que precisa","Toma atitude r√°pido","Segura press√£o e aguenta pancada","Defende limites com for√ßa"],
    9:["√â calmo(a) e equilibrado(a)","Evita brigas e acalma o ambiente","Escuta bem as pessoas","Ajuda o time a se entender","Tem paci√™ncia e const√¢ncia","Gosta de harmonia e paz","Trabalha bem em grupo"]
  };

  const TYPE_ATENCAO = {
    1:["Pode se cobrar demais","Pode ficar r√≠gido(a) e inflex√≠vel","Pode criticar muito (a si e aos outros)","Pode ter dificuldade de relaxar","Pode ficar impaciente com erros","Pode querer tudo do seu jeito","Pode ter dificuldade em delegar"],
    2:["Pode dizer ‚Äúsim‚Äù demais e se sobrecarregar","Pode ter medo de desagradar","Pode esperar reconhecimento e se frustrar","Pode se envolver demais com problemas dos outros","Pode guardar m√°goa sem falar","Pode se esquecer de si","Pode evitar conversas dif√≠ceis"],
    3:["Pode ficar ansioso(a) por resultado","Pode querer fazer tudo r√°pido demais","Pode se comparar com os outros","Pode confundir valor pessoal com desempenho","Pode colocar imagem acima do descanso","Pode ter dificuldade de parar e respirar","Pode ficar irritado(a) com lentid√£o"],
    4:["Pode oscilar no humor","Pode levar as coisas para o lado pessoal","Pode se sentir incompreendido(a)","Pode desanimar com rotina","Pode focar mais no sentimento do que na a√ß√£o","Pode comparar e se frustrar","Pode se isolar quando d√≥i"],
    5:["Pode pensar demais e agir de menos","Pode se fechar e falar pouco","Pode parecer frio(a) sem querer","Pode evitar pedir ajuda","Pode guardar tudo para si","Pode se desligar das emo√ß√µes","Pode ter dificuldade com mudan√ßas r√°pidas"],
    6:["Pode ter ansiedade e preocupa√ß√£o","Pode duvidar muito antes de decidir","Pode imaginar o pior cen√°rio","Pode precisar de garantia o tempo todo","Pode desconfiar com facilidade","Pode travar com medo de errar","Pode buscar valida√ß√£o demais"],
    7:["Pode se dispersar e perder foco","Pode come√ßar e n√£o terminar","Pode evitar assuntos dif√≠ceis","Pode agir por impulso","Pode exagerar no ritmo e cansar","Pode ter dificuldade com rotina","Pode prometer mais do que d√° conta"],
    8:["Pode falar duro e assustar","Pode querer controlar demais","Pode perder a paci√™ncia r√°pido","Pode bater de frente sem necessidade","Pode ter dificuldade de mostrar fragilidade","Pode ser ‚Äú8 ou 80‚Äù em decis√µes","Pode insistir quando seria melhor ouvir"],
    9:["Pode adiar decis√µes (procrastinar)","Pode evitar conflito e engolir inc√¥modo","Pode dizer ‚Äútanto faz‚Äù e perder prioridade","Pode aceitar demais para manter paz","Pode demorar para reagir","Pode acumular stress em sil√™ncio","Pode se acomodar quando precisa agir"]
  };

  // ================= Helpers =================
  function uniq(arr){
    const out=[]; const seen=new Set();
    for(const x of arr){
      const k=(x||"").toLowerCase().trim();
      if(!k || seen.has(k)) continue;
      seen.add(k); out.push(x);
    }
    return out;
  }
  function limit(arr, n){ return arr.slice(0,n); }

  function getLocalJSON(key){
    try{ return JSON.parse(localStorage.getItem(key) || "null"); }
    catch{ return null; }
  }

  // ‚úÖ normaliza qualquer lead que venha com chaves diferentes
  function normalizeLead(obj){
    if(!obj || typeof obj !== "object") return null;

    const nome =
      obj.nome_completo || obj.nomeCompleto || obj.nome || obj.name || obj.fullname || obj.full_name || "";

    const email =
      obj.email || obj.mail || obj.email_address || obj.emailAddress || "";

    const telefone =
      obj.telefone || obj.celular || obj.fone || obj.phone || obj.whatsapp || obj.telefone_whats || "";

    const out = {
      ...obj,
      nome_completo: String(nome || "").trim(),
      email: String(email || "").trim(),
      telefone: String(telefone || "").trim(),
    };

    // se n√£o tem nada √∫til, devolve null
    if(!out.nome_completo && !out.email && !out.telefone) return null;
    return out;
  }

  function getLead(){
    const keys = [LEAD_KEY_MAIN, LEAD_KEY_FALLBACK_1, LEAD_KEY_FALLBACK_2, LEAD_KEY_FALLBACK_3];
    for(const k of keys){
      const raw = getLocalJSON(k);
      const lead = normalizeLead(raw);
      if(lead) return lead;
    }
    return null;
  }

  function showError(msg){
    const el = document.getElementById("errBox");
    el.style.display = "block";
    el.textContent = msg;
  }

  async function loadMatriz(){
    const res = await fetch(MATRIZ_URL, { cache: "no-store" });
    if(!res.ok) throw new Error("N√£o consegui carregar data/matriz.json. Verifique se o arquivo existe na pasta /data.");
    return res.json();
  }

  function computeScore(respostas, matriz){
    const score = {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0};
    respostas.forEach(r=>{
      const key = `${r.pergunta}_${r.alternativa}`;
      const w = matriz[key];
      if(!w) return;
      for(const t in w) score[t] += w[t];
    });
    return score;
  }

  function top3FromScore(score){
    return Object.entries(score)
      .map(([t,v])=>({ t:Number(t), v:Number(v) }))
      .sort((a,b)=>b.v-a.v)
      .slice(0,3);
  }

  function renderTop3(top3){
    const list = document.getElementById("topList");
    list.innerHTML = top3.map((it, idx)=>{
      const tipo = TIPOS[it.t];
      const rank = (idx+1) + "¬∫ ‚Äî Tipo " + it.t;
      const color = TYPE_COLORS[it.t] || "#111827";
      return `
        <div class="topItem">
          <div class="left">
            <div class="rankLine">
              <span class="badge" style="background:${color}"></span>
              ${rank}
            </div>
            <div class="typeName">${tipo?.nome || ""}</div>
            <div class="desc">${tipo?.curta || ""}</div>
          </div>
          <div class="score">${it.v}</div>
        </div>
      `;
    }).join("");
  }

  // PIE (SVG)
  function polarToCartesian(cx, cy, r, angleDeg){
    const rad = (angleDeg - 90) * Math.PI / 180.0;
    return { x: cx + (r * Math.cos(rad)), y: cy + (r * Math.sin(rad)) };
  }
  function arcPath(cx, cy, r, startAngle, endAngle){
    const start = polarToCartesian(cx, cy, r, endAngle);
    const end = polarToCartesian(cx, cy, r, startAngle);
    const largeArcFlag = (endAngle - startAngle) <= 180 ? "0" : "1";
    return `M ${cx} ${cy} L ${start.x} ${start.y} A ${r} ${r} 0 ${largeArcFlag} 0 ${end.x} ${end.y} Z`;
  }
  function renderPie(top3){
    const total = top3.reduce((s,x)=>s+x.v,0) || 1;
    let start = 0;
    const cx = 110, cy = 110, r = 92;

    const slices = top3.map((it)=>{
      const frac = it.v / total;
      const angle = frac * 360;
      const end = start + angle;
      const path = arcPath(cx, cy, r, start, end);
      start = end;
      return { t: it.t, v: it.v, path };
    });

    const svg = `
      <svg width="220" height="220" viewBox="0 0 220 220" aria-label="Gr√°fico de pizza">
        ${slices.map(s=>{
          const color = TYPE_COLORS[s.t] || "#111827";
          return `<path d="${s.path}" fill="${color}" stroke="white" stroke-width="3"></path>`;
        }).join("")}
        <circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="rgba(15,23,42,.10)" stroke-width="1"/>
      </svg>
    `;
    document.getElementById("pieWrap").innerHTML = svg;
  }

  function renderTextos(top3){
    const t1 = top3[0].t, t2 = top3[1].t, t3 = top3[2].t;

    document.getElementById("quickResumo").textContent =
      `Seu tipo mais forte √© o Tipo ${t1}, com influ√™ncia dos Tipos ${t2} e ${t3}.`;

    const n1 = TIPOS[t1]?.nome || `Tipo ${t1}`;
    const n2 = TIPOS[t2]?.nome || `Tipo ${t2}`;
    const n3 = TIPOS[t3]?.nome || `Tipo ${t3}`;

    const funcionamento =
      `Sua tr√≠ade principal √© <b>${t1}-${t2}-${t3}</b>. ` +
      `O seu tipo dominante √© o <b>Tipo ${t1}</b> (${n1}). ` +
      `Na pr√°tica, isso aparece como: <b>${TIPOS[t1]?.curta || ""}</b>.` +
      `<br><br>` +
      `A influ√™ncia do <b>Tipo ${t2}</b> (${n2}) traz <b>${INFLUENCIA[t2]}</b>. ` +
      `A influ√™ncia do <b>Tipo ${t3}</b> (${n3}) traz <b>${INFLUENCIA[t3]}</b>.` +
      `<br><br>` +
      `No dia a dia, essa mistura faz voc√™ alternar o jeito de agir conforme a situa√ß√£o: √†s vezes mais focado(a) em resultado, √†s vezes mais cauteloso(a), √†s vezes mais exigente ‚Äî tudo depende do momento.`;

    document.getElementById("comoFunciona").innerHTML = funcionamento;

    const fortes = limit(
      uniq([...(TYPE_FORTES[t1]||[]), ...(TYPE_FORTES[t2]||[]), ...(TYPE_FORTES[t3]||[])]),
      7
    );
    const atencao = limit(
      uniq([...(TYPE_ATENCAO[t1]||[]), ...(TYPE_ATENCAO[t2]||[]), ...(TYPE_ATENCAO[t3]||[])]),
      7
    );

    document.getElementById("listaFortes").innerHTML = fortes.map(x=>`<li>${x}</li>`).join("");
    document.getElementById("listaAtencao").innerHTML = atencao.map(x=>`<li>${x}</li>`).join("");
  }

  function formatUserLine(user){
    if(!user) return "Nome: ‚Äî<br>Email: ‚Äî<br>Telefone: ‚Äî";
    const nome = user.nome_completo || "‚Äî";
    const email = user.email || "‚Äî";
    const tel = user.telefone || "‚Äî";
    return `Nome: ${nome}<br>Email: ${email}<br>Telefone: ${tel}`;
  }

  function buildWhatsText(user, top3){
    const nome = (user?.nome_completo || "‚Äî");
    const email = (user?.email || "‚Äî");
    const telefone = (user?.telefone || "‚Äî");

    const linhas = [];
    linhas.push("‚úÖ *Resultado do Teste (Eneagrama)*");
    linhas.push("");
    linhas.push(`*Nome:* ${nome}`);
    linhas.push(`*Email:* ${email}`);
    linhas.push(`*Telefone:* ${telefone}`);
    linhas.push("");
    linhas.push("*Top 3 (Tr√≠ade):*");
    linhas.push(`1) Tipo ${top3[0].t} ‚Äî ${top3[0].v}`);
    linhas.push(`2) Tipo ${top3[1].t} ‚Äî ${top3[1].v}`);
    linhas.push(`3) Tipo ${top3[2].t} ‚Äî ${top3[2].v}`);
    linhas.push("");
    linhas.push(`Resumo: Tipo ${top3[0].t} dominante, com influ√™ncia de ${top3[1].t} e ${top3[2].t}.`);
    return linhas.join("\n");
  }

  // ===== Pontua√ß√£o (S√ì PARA E-MAIL) =====
  function normalizeToPercent(score){
    const vals = Object.values(score).map(v=>Number(v)||0);
    const max = Math.max(...vals, 0) || 1;
    const pct = {};
    for(let t=1;t<=9;t++){
      pct[t] = Math.round((score[t] / max) * 100);
    }
    return pct;
  }

  function buildScoreBarsHtmlForEmail(score){
    const pct = normalizeToPercent(score);
    let html = "";
    for(let t=1;t<=9;t++){
      const color = (TYPE_COLORS[t] || "#f07a00");
      html += `
        <div style="display:grid;grid-template-columns:40px 1fr 52px;gap:10px;align-items:center;margin:10px 0;">
          <div style="width:40px;height:34px;display:flex;align-items:center;justify-content:center;border-radius:12px;background:#f1f5f9;color:#0b2a5b;font-weight:900;border:1px solid rgba(15,23,42,.08);">${t}</div>
          <div style="height:14px;background:#eeeeee;border-radius:999px;overflow:hidden;border:1px solid rgba(15,23,42,.06);">
            <div style="height:100%;width:${pct[t]}%;border-radius:999px;background:${color};"></div>
          </div>
          <div style="text-align:right;font-weight:900;color:#0f172a;font-size:13px;">${pct[t]}%</div>
        </div>
      `;
    }
    return html;
  }

  // ================= Email HTML (inline) =================
  function buildEmailHtml(user, top3, score){
    // ‚úÖ Aqui os dados j√° est√£o normalizados
    const nome = (user?.nome_completo || "‚Äî");
    const email = (user?.email || "‚Äî");
    const tel = (user?.telefone || "‚Äî");
    const triade = `${top3[0].t}-${top3[1].t}-${top3[2].t}`;

    const itemTop = (idx, it) => {
      const color = (TYPE_COLORS[it.t] || "#111827");
      const tipoNome = (TIPOS[it.t]?.nome || `Tipo ${it.t}`);
      const tipoCurta = (TIPOS[it.t]?.curta || "");
      return `
        <div style="border:1px solid #e5e7eb;border-radius:14px;padding:14px;background:#fff;margin-bottom:10px;">
          <div style="display:flex;justify-content:space-between;gap:14px;align-items:flex-start;">
            <div>
              <div style="font-weight:900;font-size:16px;color:#0b2a5b;display:flex;gap:10px;align-items:center;">
                <span style="width:10px;height:10px;border-radius:999px;background:${color};display:inline-block;border:1px solid rgba(0,0,0,.18);"></span>
                ${idx}¬∫ ‚Äî Tipo ${it.t}
              </div>
              <div style="font-weight:800;font-size:13px;color:#0f172a;margin-top:4px;">${tipoNome}</div>
              <div style="font-size:13px;color:#475569;line-height:1.35;margin-top:4px;">${tipoCurta}</div>
            </div>
            <div style="font-weight:900;font-size:22px;color:#0f172a;min-width:56px;text-align:right;">${it.v}</div>
          </div>
        </div>
      `;
    };

    const pieSvg = document.getElementById("pieWrap")?.innerHTML || "";
    const funcionamento = document.getElementById("comoFunciona")?.innerHTML || "";
    const fortes = document.getElementById("listaFortes")?.innerHTML || "";
    const atencao = document.getElementById("listaAtencao")?.innerHTML || "";
    const quick = document.getElementById("quickResumo")?.textContent || "";
    const scoreBars = buildScoreBarsHtmlForEmail(score);

    return `
      <div style="font-family:Arial,Helvetica,sans-serif;background:#f3f5f8;padding:18px;color:#0f172a;">
        <div style="max-width:980px;margin:0 auto;">
          <div style="font-size:40px;font-weight:900;margin:0 0 6px;">Quem sou eu</div>
          <div style="color:#64748b;font-size:14px;margin:0 0 14px;">Abaixo est√° o seu resultado com base nas respostas do formul√°rio.</div>

          <div style="background:#ffffff;border:1px solid #e5e7eb;border-radius:18px;padding:16px;box-shadow:0 12px 34px rgba(15,23,42,.10);">
            <div style="font-weight:900;font-size:18px;margin-bottom:6px;">Sua tr√≠ade principal (Top 3)</div>
            <div style="color:#64748b;font-size:13px;margin-bottom:12px;">Os 3 tipos mais altos (ordem decrescente).</div>

            <div style="display:flex;gap:14px;align-items:flex-start;flex-wrap:wrap;">
              <div style="flex:1;min-width:320px;">
                ${itemTop(1, top3[0])}
                ${itemTop(2, top3[1])}
                ${itemTop(3, top3[2])}
              </div>

              <div style="width:320px;min-width:280px;border:1px solid #e5e7eb;border-radius:14px;background:#fff;padding:12px;text-align:center;">
                ${pieSvg}
              </div>
            </div>

            <div style="margin-top:14px;background:#fff6ee;border:1px solid rgba(240,122,0,.35);border-radius:18px;padding:16px;">
              <div style="display:flex;gap:12px;flex-wrap:wrap;">
                <div style="flex:1;min-width:260px;background:#fff;border:1px solid rgba(15,23,42,.10);border-radius:14px;padding:12px;">
                  <div style="font-size:12px;color:#64748b;font-weight:800;text-transform:uppercase;letter-spacing:.3px;margin-bottom:6px;">Dados</div>
                  <div style="font-size:14px;font-weight:800;line-height:1.4;">
                    Nome: ${nome}<br>
                    Email: ${email}<br>
                    Telefone: ${tel}
                  </div>
                </div>

                <div style="flex:1.2;min-width:280px;background:#fff;border:1px solid rgba(15,23,42,.10);border-radius:14px;padding:12px;">
                  <div style="font-weight:900;font-size:14px;margin-bottom:6px;">Resumo do resultado</div>
                  <div style="font-size:13px;color:#334155;line-height:1.4;">${quick}</div>
                  <div style="margin-top:10px;font-size:13px;color:#334155;">
                    <b>Tr√≠ade:</b> ${triade}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div style="margin-top:16px;">
            <div style="font-weight:900;font-size:20px;margin:0 0 10px;">Como voc√™ tende a funcionar</div>
            <div style="background:#fff;border:1px solid #e5e7eb;border-radius:18px;padding:16px;box-shadow:0 12px 34px rgba(15,23,42,.10);">
              <div style="font-size:14px;line-height:1.55;color:#334155;">${funcionamento}</div>
            </div>
          </div>

          <div style="margin-top:14px;display:flex;gap:16px;flex-wrap:wrap;">
            <div style="flex:1;min-width:320px;background:#fff;border:1px solid #e5e7eb;border-radius:18px;padding:16px;box-shadow:0 12px 34px rgba(15,23,42,.10);">
              <div style="font-weight:900;font-size:16px;margin-bottom:10px;">Pontos fortes</div>
              <ul style="margin:0;padding-left:18px;font-size:14px;line-height:1.6;">${fortes}</ul>
            </div>

            <div style="flex:1;min-width:320px;background:#fff;border:1px solid #e5e7eb;border-radius:18px;padding:16px;box-shadow:0 12px 34px rgba(15,23,42,.10);">
              <div style="font-weight:900;font-size:16px;margin-bottom:10px;">Pontos de aten√ß√£o</div>
              <ul style="margin:0;padding-left:18px;font-size:14px;line-height:1.6;">${atencao}</ul>
            </div>
          </div>

          <div style="margin-top:14px;background:#ffffff;border:1px solid #e5e7eb;border-radius:18px;padding:16px;box-shadow:0 12px 34px rgba(15,23,42,.10);">
            <div style="font-weight:900;font-size:22px;margin:0 0 6px;">Pontua√ß√£o</div>
            <div style="color:#64748b;font-size:13px;margin:0 0 12px;">Quanto maior a barra, maior a compatibilidade com aquele tipo.</div>
            <div>${scoreBars}</div>
          </div>

          <div style="margin-top:18px;color:#94a3b8;font-size:12px;">
            Atrius ‚Ä¢ Resultado gerado automaticamente
          </div>
        </div>
      </div>
    `;
  }

  async function sendEmailOnce(user, top3, score){
    try{
      if(sessionStorage.getItem(EMAIL_SENT_LOCK) === "1"){
        setEmailStatus("ok","‚úÖ E-mail j√° enviado nesta sess√£o.","Abaixo est√° seu resultado:");
        return;
      }

      setEmailStatus("", "üì® Enviando e-mail com seu resultado‚Ä¶", "Se n√£o chegar, confira spam/abas do Gmail.");

      const nome = (user?.nome_completo || "Participante").trim();
      const assunto = `Resultado eneagrama - ${nome}`;
      const relatorio_html = buildEmailHtml(user, top3, score);

      dlog("Lead normalizado:", user);
      dlog("Assunto:", assunto);
      dlog("Tamanho HTML:", (relatorio_html || "").length);

      emailjs.init({ publicKey: EMAILJS_PUBLIC_KEY });

      await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
        // template usa {{{relatorio_html}}}
        relatorio_html,
        assunto,

        // para From Name / Reply-To no EmailJS
        name: nome,
        email: (user?.email || "")
      });

      sessionStorage.setItem(EMAIL_SENT_LOCK, "1");
      setEmailStatus("ok","‚úÖ E-mail enviado com sucesso! Abaixo est√° seu resultado:","");
      dlog("EmailJS: enviado com sucesso.");
    }catch(err){
      console.error("Erro EmailJS:", err);
      setEmailStatus("err","‚ùå N√£o consegui enviar o e-mail agora.","Veja o console (F12) ou tente recarregar a p√°gina.");
      dlog("EmailJS erro:", err?.text || err?.message || err);
    }
  }

  // ================= WhatsApp =================
  let __lastTop3 = null;
  let __lastUser = null;

  document.getElementById("btnWhats").addEventListener("click", ()=>{
    if(!__lastTop3){
      alert("Ainda estou carregando o resultado. Tente novamente em 1 segundo.");
      return;
    }
    const msg = buildWhatsText(__lastUser, __lastTop3);
    const url = `https://wa.me/${WHATS_NUMBER}?text=${encodeURIComponent(msg)}`;
    window.open(url, "_blank");
  });

  // ================= init =================
  (async function init(){
    try{
      // ‚úÖ se console estiver filtrado, voc√™ pode abrir com ?debug=1 para ver na tela
      dlog("Init resultado.html");

      const respostas = getLocalJSON(RESPOSTAS_KEY) || [];
      const user = getLead();

      __lastUser = user;
      document.getElementById("dadosUser").innerHTML = formatUserLine(user);

      dlog("Respostas length:", Array.isArray(respostas) ? respostas.length : "n√£o-array");
      dlog("Lead (raw->normalized):", user);

      if(!Array.isArray(respostas) || respostas.length === 0){
        showError("N√£o encontrei respostas salvas. Volte e finalize o teste novamente.");
        document.getElementById("quickResumo").textContent = "Sem dados.";
        document.getElementById("comoFunciona").textContent = "Sem dados.";
        setEmailStatus("err","‚ùå N√£o encontrei respostas salvas.","Volte e finalize o teste novamente.");
        return;
      }

      const matriz = await loadMatriz();
      const score = computeScore(respostas, matriz);
      const top3 = top3FromScore(score);

      __lastTop3 = top3;

      renderTop3(top3);
      renderPie(top3);
      renderTextos(top3);

      // ‚úÖ envia e-mail (uma vez por sess√£o)
      if(user && user.email){
        await sendEmailOnce(user, top3, score);
      }else{
        setEmailStatus("err","‚ö†Ô∏è N√£o encontrei o e-mail do participante.","Revise a p√°gina inicial: o lead precisa ser salvo no localStorage com email.");
        dlog("Sem user.email ‚Äî n√£o enviou email.");
      }

    }catch(err){
      console.error(err);
      showError(err?.message || String(err));
      document.getElementById("quickResumo").textContent = "Erro ao carregar.";
      document.getElementById("comoFunciona").textContent = "Erro ao carregar.";
      setEmailStatus("err","‚ùå Erro ao carregar o resultado.", err?.message || String(err));
      dlog("Erro init:", err?.message || err);
    }
  })();
</script>
</body>
</html>
