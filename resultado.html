<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Quem sou eu — Resultado</title>

<style>
:root{
  --accent:#f07a00;
  --bg:#f6f7fb;
  --card:#fff;
  --bd:#e7e7e7;
  --text:#111;
  --muted:#666;
  --soft:#fafafa;
}
*{box-sizing:border-box}
body{margin:0;font-family:Arial,sans-serif;background:var(--bg);color:var(--text);}
.wrap{max-width:1100px;margin:0 auto;padding:16px;}
.card{background:var(--card);border-radius:18px;padding:16px;box-shadow:0 10px 28px rgba(0,0,0,.06);}
h1{margin:0 0 6px;font-size:34px;letter-spacing:-.2px}
.muted{color:var(--muted);font-size:14px;line-height:1.45}
hr{border:0;border-top:1px solid var(--bd);margin:16px 0}

.grid{
  display:grid;
  grid-template-columns: 1.4fr .9fr;
  gap:14px;
  align-items:start;
}
@media(max-width:900px){
  .grid{grid-template-columns:1fr}
}

.panel{
  border:1px solid var(--bd);
  border-radius:16px;
  padding:14px;
}

.h2{margin:0 0 6px;font-size:18px}
.small{font-size:13px;color:var(--muted);line-height:1.4}

.row{
  display:grid;
  grid-template-columns:44px 1fr 64px;
  align-items:center;
  gap:10px;
  margin:10px 0;
}
.badge{
  width:36px;height:36px;border-radius:999px;
  background:#f1f1f1;display:flex;align-items:center;justify-content:center;
  font-weight:800;
}
.bar{
  height:10px;background:#e9e9e9;border-radius:999px;overflow:hidden;
}
.fill{height:100%;background:var(--accent);border-radius:999px}
.pct{font-weight:800;text-align:right}

.topbox{
  border:1px solid rgba(240,122,0,.25);
  background:rgba(240,122,0,.06);
  border-radius:16px;
  padding:14px;
}
.topitem{
  display:flex;align-items:center;justify-content:space-between;
  background:#fff;border:1px solid rgba(0,0,0,.06);
  border-radius:14px;padding:12px 12px;margin-top:10px;
}
.topitem b{font-size:16px}
.score{font-weight:900}

.chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.chip{
  border:1px solid var(--bd);
  border-radius:999px;
  padding:8px 10px;
  font-size:13px;
  background:var(--soft);
}

.box{
  border:1px solid var(--bd);
  border-radius:16px;
  padding:14px;
  margin-top:14px;
  background:#fff;
}
.box h3{margin:0 0 8px;font-size:16px}
ul{margin:8px 0 0 18px;padding:0}
li{margin:6px 0;color:#222;line-height:1.35}

.actions{
  display:flex;gap:10px;margin-top:14px;flex-wrap:wrap;
}
.btn{
  padding:14px 16px;
  border-radius:14px;
  border:0;
  font-weight:900;
  cursor:pointer;
}
.btn-outline{background:#fff;border:1px solid var(--bd)}
.btn-primary{background:var(--accent);color:#fff;flex:1;min-width:220px}
</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>Quem sou eu</h1>
    <p class="muted">Abaixo está o seu resultado com base nas respostas do formulário.</p>

    <div class="grid">
      <!-- LEFT: barras -->
      <div class="panel">
        <div class="h2">Pontuação por Eneatipo</div>
        <div class="small">Quanto maior a barra, maior a compatibilidade com aquele tipo.</div>

        <div id="bars"></div>

        <div id="diag" class="small" style="margin-top:10px;color:#b00020;display:none;"></div>
      </div>

      <!-- RIGHT: top 3 + resumo -->
      <div class="topbox">
        <div class="h2">Top 3</div>
        <div class="small">Os 3 tipos mais altos (ordem decrescente).</div>

        <div id="top3"></div>

        <div class="actions">
          <button class="btn btn-outline" id="btnBack">Voltar</button>
          <button class="btn btn-primary" id="btnReset">Refazer teste</button>
        </div>
      </div>
    </div>

    <!-- blocos explicativos -->
    <div id="insights"></div>

  </div>
</div>

<script>
const STORAGE_KEY = "respostas";
const MATRIX_URL = "./data/matriz.json"; // raiz/resultado.html -> data/matriz.json

const typeNames = {
  1: {title:"Tipo 1", nick:"O Perfeccionista / Reformador"},
  2: {title:"Tipo 2", nick:"O Prestativo"},
  3: {title:"Tipo 3", nick:"O Realizador"},
  4: {title:"Tipo 4", nick:"O Individualista"},
  5: {title:"Tipo 5", nick:"O Investigador"},
  6: {title:"Tipo 6", nick:"O Leal"},
  7: {title:"Tipo 7", nick:"O Entusiasta"},
  8: {title:"Tipo 8", nick:"O Desafiador"},
  9: {title:"Tipo 9", nick:"O Pacificador"}
};

const shortDesc = {
  1: "Busca fazer o correto, melhorar padrões e evitar erros.",
  2: "Busca ajudar, ser útil e manter vínculo com as pessoas.",
  3: "Busca alcançar resultados, ser reconhecido e vencer desafios.",
  4: "Busca autenticidade, profundidade e identidade própria.",
  5: "Busca entender, analisar e ter autonomia intelectual/energia.",
  6: "Busca segurança, previsibilidade e confiança no ambiente.",
  7: "Busca liberdade, possibilidades e experiências positivas.",
  8: "Busca força, controle e não ser dominado por ninguém.",
  9: "Busca harmonia, estabilidade e evitar conflitos desnecessários."
};

const strengths = {
  1: ["Capricho, padrão e qualidade", "Senso de justiça e coerência", "Responsabilidade e disciplina"],
  2: ["Cuidado e suporte ao outro", "Boa leitura de pessoas", "Lealdade e presença"],
  3: ["Foco em meta e execução", "Competitividade saudável", "Capacidade de liderança e entrega"],
  4: ["Profundidade e sensibilidade", "Criatividade e visão estética", "Autenticidade"],
  5: ["Análise, estratégia e concentração", "Independência e clareza", "Racionalidade em pressão"],
  6: ["Prevenção de riscos", "Lealdade e comprometimento", "Consistência e prudência"],
  7: ["Otimismo e energia", "Criatividade e alternativas", "Adaptabilidade"],
  8: ["Coragem e decisão", "Proteção e força", "Objetividade e firmeza"],
  9: ["Equilíbrio e paciência", "Capacidade de conciliar", "Estabilidade emocional"]
};

const watchouts = {
  1: ["Rigidez e autocobrança", "Irritação com erros alheios", "Dificuldade em relaxar"],
  2: ["Excesso de doação", "Querer agradar para ser aceito", "Dificuldade em dizer 'não'"],
  3: ["Viver no modo performance", "Comparação e ansiedade por resultado", "Desconectar de emoções reais"],
  4: ["Oscilar emocionalmente", "Sensação de falta/insatisfação", "Idealização"],
  5: ["Isolamento e distanciamento", "Superanálise e procrastinação", "Cansaço social"],
  6: ["Dúvida e antecipação negativa", "Necessidade de confirmação", "Tensão e alerta"],
  7: ["Dispersão e fuga do incômodo", "Impulsos/excessos", "Dificuldade em concluir"],
  8: ["Controlar demais", "Confronto desnecessário", "Dureza e impaciência"],
  9: ["Evitar conflito por padrão", "Adiar decisões", "Desligar do próprio desejo"]
};

function getRespostas(){
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
  catch { return []; }
}

async function loadMatrix(){
  const res = await fetch(MATRIX_URL, { cache:"no-store" });
  if(!res.ok) throw new Error("Não foi possível carregar matriz.json ("+res.status+")");
  return await res.json();
}

function calcScores(respostas, matriz){
  const score = {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0};
  let matched = 0;
  let missingKeys = [];

  for(const r of respostas){
    const key = `${r.pergunta}_${r.alternativa}`;
    const w = matriz[key];
    if(!w){ missingKeys.push(key); continue; }
    matched++;
    for(const t in w){
      score[t] += Number(w[t]) || 0;
    }
  }
  return {score, matched, missingKeys};
}

function toPercent(scores){
  const max = Math.max(...Object.values(scores));
  const pct = {};
  for(let i=1;i<=9;i++){
    pct[i] = max ? Math.round((scores[i]/max)*100) : 0;
  }
  return {pct, max};
}

function renderBars(pct){
  const el = document.getElementById("bars");
  el.innerHTML = "";
  for(let i=1;i<=9;i++){
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div class="badge">${i}</div>
      <div class="bar"><div class="fill" style="width:${pct[i]}%"></div></div>
      <div class="pct">${pct[i]}%</div>
    `;
    el.appendChild(row);
  }
}

function sortTop3(scores){
  const arr = [];
  for(let i=1;i<=9;i++) arr.push({t:i, v:scores[i]});
  arr.sort((a,b)=>b.v-a.v);
  return arr.slice(0,3);
}

function renderTop3(top){
  const el = document.getElementById("top3");
  el.innerHTML = "";
  top.forEach((x, idx)=>{
    const t = x.t;
    const box = document.createElement("div");
    box.className = "topitem";
    box.innerHTML = `
      <div>
        <b>${idx+1}º — ${typeNames[t].title}</b>
        <div class="small">${typeNames[t].nick}</div>
      </div>
      <div class="score">${x.v}</div>
    `;
    el.appendChild(box);
  });
}

function renderInsights(top){
  const [a,b,c] = top.map(x=>x.t);
  const main = a;

  const el = document.getElementById("insights");
  el.innerHTML = `
    <div class="box">
      <h3>Leitura rápida do seu Top 3</h3>
      <div class="chips">
        <span class="chip"><b>${typeNames[a].title}:</b> ${shortDesc[a]}</span>
        <span class="chip"><b>${typeNames[b].title}:</b> ${shortDesc[b]}</span>
        <span class="chip"><b>${typeNames[c].title}:</b> ${shortDesc[c]}</span>
      </div>
    </div>

    <div class="box">
      <h3>O que aparece mais forte em você (Tipo ${main})</h3>
      <div class="small" style="margin-top:2px">${shortDesc[main]}</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px">
        <div class="panel" style="background:#fff">
          <div class="h2">Forças</div>
          <ul>${strengths[main].map(x=>`<li>${x}</li>`).join("")}</ul>
        </div>
        <div class="panel" style="background:#fff">
          <div class="h2">Pontos de atenção</div>
          <ul>${watchouts[main].map(x=>`<li>${x}</li>`).join("")}</ul>
        </div>
      </div>
    </div>

    <div class="box">
      <h3>Próximos passos (auto-observação)</h3>
      <ul>
        <li>Quando você sente <b>pressa por resultado</b>, o que você está tentando provar ou garantir?</li>
        <li>Em que momentos você entra em <b>rigidez/autocobrança</b> (Tipo 1 aparecendo)?</li>
        <li>Onde você busca <b>segurança/certeza</b> antes de agir (Tipo 6 aparecendo)?</li>
      </ul>
    </div>
  `;
}

function bindActions(){
  document.getElementById("btnBack").onclick = ()=> history.back();
  document.getElementById("btnReset").onclick = ()=>{
    if(confirm("Deseja apagar suas respostas e refazer o teste?")){
      localStorage.removeItem(STORAGE_KEY);
      window.location.href = "./index.html";
    }
  };
}

(async function main(){
  bindActions();

  const respostas = getRespostas();
  if(!respostas.length){
    document.getElementById("diag").style.display = "block";
    document.getElementById("diag").textContent = "Nenhuma resposta encontrada. Volte e faça o teste.";
    return;
  }

  let matriz;
  try{
    matriz = await loadMatrix();
  }catch(e){
    document.getElementById("diag").style.display = "block";
    document.getElementById("diag").textContent = "Erro ao carregar matriz: " + e.message;
    return;
  }

  const {score, matched, missingKeys} = calcScores(respostas, matriz);
  const {pct, max} = toPercent(score);

  renderBars(pct);
  const top = sortTop3(score);
  renderTop3(top);
  renderInsights(top);

  // diagnóstico suave (só mostra se algo estiver muito errado)
  if(max === 0 || matched === 0){
    const d = document.getElementById("diag");
    d.style.display = "block";
    d.textContent = "Nenhuma pontuação foi calculada. Verifique se a matriz tem as mesmas chaves das respostas.";
  }
})();
</script>

</body>
</html>
