<script>
const STORAGE_KEY="respostas";

/* ================= STORAGE ================= */
function getList(){
  try {
    return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
  } catch {
    return [];
  }
}
function setList(l){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(l));
}

function upsert(pergunta, alternativa){
  const l = getList();
  const i = l.findIndex(x => x.pergunta === pergunta);
  if (i >= 0) l[i].alternativa = alternativa;
  else l.push({ pergunta, alternativa });
  setList(l);
}

/* ================= RESTORE ================= */
function restore(){
  const l = getList();
  for (const r of l) {
    const el = document.querySelector(
      `input[name="${r.pergunta}"][value="${r.alternativa}"]`
    );
    if (el) el.checked = true;
  }
}

/* ================= VALIDATION ================= */
function validateAll(){
  const form = document.getElementById("formP2");
  const names = [...new Set(
    [...form.querySelectorAll('input[type="radio"]')].map(i => i.name)
  )];
  const missing = names.filter(n =>
    !form.querySelector(`input[name="${n}"]:checked`)
  );
  if (missing.length){
    alert("Responda todas as questÃµes desta pÃ¡gina antes de continuar.");
    const first = form.querySelector(`input[name="${missing[0]}"]`);
    if (first) first.scrollIntoView({ behavior:"smooth", block:"center" });
    return false;
  }
  return true;
}

/* ================= INIT ================= */
document.addEventListener("DOMContentLoaded",()=>{

  // ðŸ”’ PROTEÃ‡ÃƒO DE FLUXO
  // Se alguÃ©m cair aqui sem iniciar o teste, volta para a index
  const respostas = getList();
  if (!respostas || respostas.length === 0){
    window.location.href = "/"; // index
    return;
  }

  restore();

  document.querySelectorAll('#formP2 input[type="radio"]').forEach(inp=>{
    inp.addEventListener("change",()=>{
      upsert(inp.name, inp.value);
    });
  });

  document.getElementById("btnProximo").addEventListener("click",()=>{
    if(!validateAll()) return;
    window.location.href="./page3.html";
  });
});
</script>
