<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Quem sou eu — Passo 4</title>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

<style>
:root{
  --accent:#f07a00;
  --accent-weak: rgba(240,122,0,.12);
  --accent-border: rgba(240,122,0,.45);
  --bg:#f6f7fb;
  --card:#ffffff;
  --bd:#e7e7e7;
  --text:#111;
  --muted:#666;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
}
.wrap{max-width:980px;margin:auto;padding:16px;}
.card{
  background:var(--card);
  border-radius:18px;
  padding:16px;
  box-shadow:0 10px 28px rgba(0,0,0,.06);
}
h1{margin:0 0 6px;font-size:32px;}
.muted{color:var(--muted);font-size:14px;line-height:1.4}

.step{margin:12px 0}
.bar{height:10px;background:#e9e9e9;border-radius:999px;overflow:hidden;margin-top:6px;}
.fill{height:100%;width:100%;background:var(--accent);}

.grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:12px;
  margin-top:14px;
}
@media(max-width:768px){ .grid{grid-template-columns:1fr;} }

.word{
  border:1px solid var(--bd);
  border-radius:16px;
  padding:14px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  cursor:pointer;
  background:#fff;
  transition:all .15s ease;
}
.word.selected{
  background:var(--accent-weak);
  border-color:var(--accent-border);
  box-shadow:0 0 0 3px var(--accent-weak);
}
.word small{color:#888;font-weight:800;min-width:26px}
.word input{transform:scale(1.2)}

.actions{
  display:flex;
  gap:10px;
  margin-top:16px;
}
.btn{
  padding:14px;
  border-radius:14px;
  border:0;
  font-weight:900;
  cursor:pointer;
}
.btn-primary{background:var(--accent);color:#fff;flex:1}
.btn-outline{background:#fff;border:1px solid var(--bd)}
</style>
</head>

<body>
<div class="wrap">
<div class="card">

<h1>Quem sou eu</h1>
<p class="muted">Marque apenas as palavras que realmente combinam com você ao longo da vida.</p>

<div class="step">
  <b>Passo 4 de 4 — Identificação pessoal</b>
  <div class="bar"><div class="fill"></div></div>
</div>

<p class="muted"><b>Instruções:</b> selecione pelo menos <b>6 opções</b>.</p>

<form id="formP4">
  <div class="grid" id="gridWords"></div>

  <div class="actions">
    <button type="button" class="btn btn-outline" onclick="history.back()">Voltar</button>
    <button type="button" id="btnFinish" class="btn btn-primary">Ver resultado</button>
  </div>
</form>

</div>
</div>

<script>
/* ================= EMAILJS ================= */
emailjs.init("dMy7jYWSeALMDD7TI");

/* ================= CONFIG ================= */
const STORAGE_KEY = "respostas";
const MIN = 6;

// Lead + Totais (para resultado.html)
const LEAD_KEY = "atrius_eneagrama_lead_v1";
const TOTAIS_KEY = "atrius_eneagrama_totais_v1";

/* ================= PALAVRAS ================= */
const palavras = [
  "Comprometido(a)","Cuidadoso(a)","Determinado(a)","Competitivo(a)","Analítico(a)","Reservado(a)",
  "Organizado(a)","Prático(a)","Independente","Leal","Intenso(a)","Flexível",
  "Persistente","Disciplinado(a)","Observador(a)","Responsável","Focado(a)","Autêntico(a)",
  "Sensível","Protetor(a)","Questionador(a)","Cauteloso(a)","Otimista","Entusiasmado(a)",
  "Direto(a)","Assertivo(a)","Tranquilo(a)","Harmonioso(a)","Criativo(a)","Curioso(a)"
];

/* ================= HELPERS ================= */
function getList(){
  try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
  catch{ return []; }
}
function setList(l){ localStorage.setItem(STORAGE_KEY, JSON.stringify(l)); }

function upsertCheckbox(name, checked){
  let l = getList().filter(x => x.pergunta !== name);
  if(checked) l.push({ pergunta:name, alternativa:"S" });
  setList(l);
}

function countSelected(){
  return document.querySelectorAll('#formP4 input[type="checkbox"]:checked').length;
}

function getLead(){
  const raw = localStorage.getItem(LEAD_KEY);
  if(!raw) return null;
  try{
    const lead = JSON.parse(raw);
    const nomeCompleto =
      lead.nome_completo ||
      `${lead.nome || ""} ${lead.sobrenome || ""}`.trim();

    return {
      ...lead,
      nome_completo: nomeCompleto || "Participante",
      email: (lead.email || "").trim(),
      telefone: (lead.telefone || "").trim()
    };
  }catch{
    return null;
  }
}

/* ================= BUILD ================= */
function build(){
  const grid = document.getElementById("gridWords");
  grid.innerHTML = palavras.map((p,i)=>{
    const n = String(i+1).padStart(2,"0");
    return `
      <div class="word" data-name="P4_${n}">
        <span><small>${i+1}.</small> ${p}</span>
        <input type="checkbox" name="P4_${n}">
      </div>
    `;
  }).join("");

  grid.querySelectorAll(".word").forEach(card=>{
    const cb = card.querySelector("input");
    card.addEventListener("click", e=>{
      if(e.target !== cb) cb.checked = !cb.checked;
      card.classList.toggle("selected", cb.checked);
      upsertCheckbox(cb.name, cb.checked);
    });
    cb.addEventListener("change",()=>{
      card.classList.toggle("selected", cb.checked);
      upsertCheckbox(cb.name, cb.checked);
    });
  });
}

function restore(){
  getList().forEach(r=>{
    if(!r.pergunta.startsWith("P4_")) return;
    const cb = document.querySelector(`input[name="${r.pergunta}"]`);
    if(cb){
      cb.checked = true;
      cb.closest(".word").classList.add("selected");
    }
  });
}

/* ================= EMAIL CONTENT (9 no topo) ================= */
function eneagramaSvgEmail(){
  return `
    <div style="text-align:center;margin:18px 0;">
      <svg width="260" height="260" viewBox="0 0 260 260" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Símbolo do Eneagrama">
        <defs>
          <style>
            .c{fill:none;stroke:#111827;stroke-width:3}
            .l{fill:none;stroke:#111827;stroke-width:2}
            .n{font: 700 14px Arial, sans-serif; fill:#111827}
          </style>
        </defs>

        <circle class="c" cx="130" cy="130" r="102"/>
        <!-- triângulo 9-3-6 (9 topo) -->
        <path class="l" d="M130 28 L209 175 L51 175 Z"/>
        <!-- estrela simples -->
        <path class="l" d="M206 88 L157 220 L245 142 L15 142 L103 220 L54 88 L206 88"/>

        <!-- números com 9 no topo -->
        <text class="n" x="124" y="20">9</text>
        <text class="n" x="187" y="40">1</text>
        <text class="n" x="227" y="95">2</text>
        <text class="n" x="220" y="165">3</text>
        <text class="n" x="165" y="232">4</text>
        <text class="n" x="124" y="248">5</text>
        <text class="n" x="78"  y="232">6</text>
        <text class="n" x="24"  y="165">7</text>
        <text class="n" x="18"  y="95">8</text>
      </svg>
    </div>
  `;
}

function tabelaTotaisEmail(score){
  let rows = "";
  for(let i=1;i<=9;i++){
    rows += `
      <tr>
        <td style="padding:10px;border:1px solid #e5e7eb;text-align:center;font-weight:800;">${i}</td>
        <td style="padding:10px;border:1px solid #e5e7eb;text-align:center;">${score[i] ?? 0}</td>
      </tr>
    `;
  }
  return `
    <table style="width:100%;border-collapse:collapse;font-family:Arial,sans-serif;font-size:14px;">
      <thead>
        <tr>
          <th style="padding:10px;border:1px solid #e5e7eb;background:#f8fafc;">Tipo</th>
          <th style="padding:10px;border:1px solid #e5e7eb;background:#f8fafc;">Quantidade</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

/* ================= EMAIL ================= */
async function sendEmailReport(){
  const lead = getLead();
  if(!lead || !lead.email){
    // Se você preferir bloquear sem lead:
    // throw new Error("Lead não encontrado. Volte ao início e preencha Nome/Email/Telefone.");
    console.warn("Lead não encontrado ou sem email. Envio vai usar nome padrão.");
  }

  const respostas = getList();

  const res = await fetch("../data/matriz.json", { cache:"no-store" });
  const matriz = await res.json();

  // Score 1..9
  const score = {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0};

  respostas.forEach(r=>{
    const key = `${r.pergunta}_${r.alternativa}`;
    const w = matriz[key];
    if(!w) return;
    for(const t in w){
      score[t] += w[t];
    }
  });

  // Salva para o resultado.html
  localStorage.setItem(TOTAIS_KEY, JSON.stringify(score));

  const top = Object.entries(score)
    .map(([t,v])=>({t, v}))
    .sort((a,b)=>b.v-a.v)
    .slice(0,3);

  const nomeCompleto = (lead?.nome_completo || "Participante").trim();
  const emailReply = (lead?.email || "").trim();
  const telefoneTxt = (lead?.telefone || "-").trim();

  const html = `
    <div style="font-family:Arial,sans-serif;color:#0f172a;line-height:1.5;">
      <h2 style="margin:0 0 10px;">Resultado Eneagrama</h2>

      <div style="font-size:14px;color:#334155;margin-bottom:14px;">
        <div><b>Nome:</b> ${nomeCompleto}</div>
        <div><b>Email:</b> ${emailReply || "-"}</div>
        <div><b>Telefone:</b> ${telefoneTxt}</div>
      </div>

      ${eneagramaSvgEmail()}

      <div style="margin:12px 0; font-size:14px;">
        <b>Top 3:</b>
        <ul style="margin:8px 0 0; padding-left:18px;">
          <li>Tipo ${top[0]?.t ?? "-"} — ${top[0]?.v ?? "-"}</li>
          <li>Tipo ${top[1]?.t ?? "-"} — ${top[1]?.v ?? "-"}</li>
          <li>Tipo ${top[2]?.t ?? "-"} — ${top[2]?.v ?? "-"}</li>
        </ul>
      </div>

      <div style="margin-top:14px;">
        <h3 style="margin:0 0 8px; font-size:16px;">Pontuação completa (1 a 9)</h3>
        ${tabelaTotaisEmail(score)}
      </div>

      <div style="margin-top:14px;font-size:12px;color:#64748b;">
        Atrius • Teste de Competências Emocionais
      </div>
    </div>
  `;

  // ✅ TEMPLATE PARAMS EXATOS DO SEU TEMPLATE (print)
  // Subject: {{subject}}
  // Content: {{{conteudo_html}}}
  // From Name: {{name}}
  // Reply To: {{email}}
  const templateParams = {
    subject: `Resultado eneagrama - ${nomeCompleto}`,
    conteudo_html: html,
    name: nomeCompleto,
    email: emailReply || "nao-informado@atrius.ind.br"
  };

  console.log("DEBUG templateParams:", templateParams);

  await emailjs.send(
    "service_676gehg",
    "template_jkxxqz5",
    templateParams
  );
}

/* ================= INIT ================= */
document.addEventListener("DOMContentLoaded",()=>{
  build();
  restore();

  document.getElementById("btnFinish").addEventListener("click", async ()=>{
    if(countSelected() < MIN){
      alert("Selecione pelo menos " + MIN + " opções.");
      return;
    }

    const btn = document.getElementById("btnFinish");
    btn.disabled = true;
    btn.textContent = "Calculando...";

    try{
      await sendEmailReport();
    }catch(err){
      console.error("Erro ao enviar email:", err);
      // mesmo se der erro, você pode seguir pro resultado
      // se quiser bloquear, troque para: alert(...) e return;
    }

    // Vai para o resultado
    window.location.href = "../resultado.html";
  });
});
</script>

</body>
</html>
